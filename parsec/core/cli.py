import trio
import click

from .app import CoreApp
from .config import CONFIG


JOHN_DOE_IDENTITY = 'johndoe@test'
JOHN_DOE_PRIVATE_KEY = b'\xb8\xdd\xf4\x97\xe8\xb5/\x9c\x99\x83hO\x1e$\xf2q\x17<4l<`)eI\xe9\xba3\x1a*\x8bU'
DEFAULT_CORE_UNIX_SOCKET = 'tcp://127.0.0.1:6776'


def run_with_pdb(cmd, *args, **kwargs):
    import pdb, traceback, sys
    # Stolen from pdb.main
    pdb_context = pdb.Pdb()
    try:
        ret = pdb_context.runcall(cmd, **kwargs)
        print("The program finished")
        return ret
    except pdb.Restart:
        print("Restarting %s with arguments: %s, %s" % (cmd.__name__, args, kwargs))
        # Yes, that's a hack
        return run_with_pdb(cmd, *args, **kwargs)
    except SystemExit:
        # In most cases SystemExit does not warrant a post-mortem session.
        print("The program exited via sys.exit(). Exit status:", end=' ')
        print(sys.exc_info()[1])
    except SyntaxError:
        traceback.print_exc()
        sys.exit(1)
    except:
        traceback.print_exc()
        print("Uncaught exception. Entering post mortem debugging")
        print("Running 'cont' or 'step' will restart the program")
        t = sys.exc_info()[2]
        pdb_context.interaction(None, t)
        print("Post mortem debugger finished.")


@click.command()
@click.option('--socket', '-s', default=DEFAULT_CORE_UNIX_SOCKET,
              help='Path to the UNIX socket exposing the core API (default: %s).' %
              DEFAULT_CORE_UNIX_SOCKET)
@click.option('--backend-host', '-H', default='ws://127.0.0.1:6777')
@click.option('--backend-watchdog', '-W', type=click.INT, default=None)
@click.option('--debug', '-d', is_flag=True)
@click.option('--pdb', is_flag=True)
# @click.option('--identity', '-i', default=None)
# @click.option('--identity-key', '-I', type=click.File('rb'), default=None)
@click.option('--I-am-John', is_flag=True, help='Log as dummy John Doe user')
# @click.option('--cache-size', help='Max number of elements in cache', default=1000)
def core_cmd(**kwargs):
    if kwargs.pop('pdb'):
        return run_with_pdb(_core, **kwargs)
    else:
        return _core(**kwargs)


def _core(socket, backend_host, backend_watchdog, debug, i_am_john):
    # TODO: so far LocalStorage is not implemented, so use the testing mock...
    from . import local_fs
    from tests.common import mocked_local_storage_cls_factory
    local_fs.LocalStorage = mocked_local_storage_cls_factory()
    config = {
        **CONFIG,
        'DEBUG': debug,
        'BACKEND_URL': backend_host,
        'BACKEND_WATCHDOG': backend_watchdog,
        'ADDR': socket
    }
    core = CoreApp(config)

    async def _run_and_login(identity, rawkey):
        async def _login_on_ready():
            await core.server_ready.wait()
            await core.login(identity, rawkey)
            print('Logged as %s' % identity)

        async with trio.open_nursery() as nursery:
            nursery.start_soon(core.run)
            nursery.start_soon(_login_on_ready)

    print('Starting Parsec Core on %s' % config['ADDR'])
    try:
        if i_am_john:
            # TODO: well well well...
            from tests.common import User
            from tests.populate_local_storage import populate_local_storage_cls
            from nacl.public import PrivateKey
            populate_local_storage_cls(User(JOHN_DOE_IDENTITY, PrivateKey(JOHN_DOE_PRIVATE_KEY)), local_fs.LocalStorage)

            trio.run(_run_and_login, JOHN_DOE_IDENTITY, JOHN_DOE_PRIVATE_KEY)
        else:
            trio.run(core.run)
    except KeyboardInterrupt:
        print('bye ;-)')
